---
title: Проектирование пространственного сопоставления
description: Эффективное использование пространственного сопоставления в HoloLens требует тщательного рассмотрения многих факторов.
author: cre8ivepark
ms.author: dongpark
ms.date: 03/21/2018
ms.topic: article
keywords: Windows Mixed Reality, проектирование, пространственное сопоставление, HoloLens, реконструкция поверхностей, сеть
ms.openlocfilehash: 451213a79e1d482d64725ce750065611830beec3
ms.sourcegitcommit: 17f86fed532d7a4e91bd95baca05930c4a5c68c5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/11/2019
ms.locfileid: "66829961"
---
# <a name="spatial-mapping-design"></a>Проектирование пространственного сопоставления

Эффективное использование пространственного сопоставления в HoloLens требует тщательного рассмотрения многих факторов.

## <a name="device-support"></a>Поддержка устройств

<table>
    <colgroup>
    <col width="33%" />
    <col width="33%" />
    <col width="33%" />
    </colgroup>
    <tr>
        <td><strong>Возможность</strong></td>
        <td><a href="hololens-hardware-details.md"><strong>HoloLens</strong></a></td>
        <td><a href="immersive-headset-hardware-details.md"><strong>Иммерсивные гарнитуры</strong></a></td>
    </tr>
     <tr>
        <td>Проектирование пространственного сопоставления</td>
        <td>✔️</td>
        <td>❌</td>
    </tr>
</table>

## <a name="why-is-spatial-mapping-important"></a>Зачем важны пространственное сопоставление?

Пространственное сопоставление позволяет размещать объекты на реальных поверхностях. Это помогает привязать объекты в мире пользователя и использовать преимущества реальных подсказок по глубине мира. Окклудинг свои голограммы, основанные на других голограммах и реальных объектах, помогут убедить пользователя, что эти голограммы действительно находятся в своем пространстве. Голограммы с плавающей запятой или перемещение с помощью пользователя не будут реальными. По возможности размещайте элементы для удобства.

Визуализируйте поверхности при помещении или перемещении голограмм (используйте простую проецируемую сетку). Это поможет пользователю понять, где можно лучше разместить свои голограммы, и показывает, что пользователь пытается разместить голограмму, но еще не сопоставлена. Вы можете «элементы объявления» ближе к пользователю, если они имеют слишком большую часть угла.

## <a name="what-influences-spatial-mapping-quality"></a>Что влияет на качество пространственного сопоставления?

Чтобы обеспечить оптимальное взаимодействие с пользователем, важно понимать факторы, влияющие на качество данных пространственного сопоставления, собираемых HoloLens.

Ошибки в данных пространственного сопоставления попадают в одну из трех категорий:
* **Отверстия**: В данных пространственного сопоставления отсутствуют поверхности реального мира.
* **ХаллуЦинатионс**: Поверхности существуют в данных пространственного сопоставления, которые не существуют в реальном мире.
* **Сдвиг**: Поверхности в данных пространственного сопоставления несовершенно согласованы с реальными областями, которые либо помещаются в, либо извлекаются.

Частота и серьезность этих ошибок могут влиять на несколько факторов.

* **Перемещение пользователя**
   * Способ, которым пользователь проходит через свою среду, определяет, насколько хорошо будет проверяться среда, поэтому пользователю может потребоваться предоставить рекомендации для достижения хорошей проверки.
   * Камера, используемая для сканирования, предоставляет данные в пределах 70 градусов от минимума 0,8 метров до максимума в 3,1 метров от камеры. Реальные поверхности будут проверяться только в этом поле представления. Обратите внимание, что эти значения могут быть изменены в будущих версиях.
   * Если пользователь не получает значение в пределах 3,1 метров объекта, он не будет проверяться.
   * Если пользователь просматривает объект только с расстояния менее 0,8 метров, он не будет проверяться (это позволяет избежать сканирования руки пользователя).
   * Если пользователь не смотрит вверх (что является довольно нормальным), то, скорее всего, не будет сканироваться.
   * Если пользователь никогда не просматривает мебель или стену, объекты, перекрыто их, не будут проверяться.
   * Поверхности обычно проверяются с более высоким качеством, когда они просматриваются с помощью головного, а не небольшого угла.
   * В случае сбоя системы отслеживания головного компьютера HoloLens (что может произойти из-за быстрого движения пользователей, плохого освещения, безкомпонентных стен или камер), это может привести к ошибкам в данных пространственного сопоставления. Такие ошибки будут исправлены со временем по мере того, как пользователь продолжит перемещаться и сканировать среду.

* **Материалы для Surface**
   * Материалы, найденные на реальных поверхностях, значительно отличаются. Это влияет на качество данных пространственного сопоставления, поскольку они влияют на способ отражения инфракрасного излучения.
   * Темные поверхности могут не сканироваться, пока они не поступают ближе к камере, так как они отображают меньшее освещение.
   * Некоторые поверхности могут быть настолько темными, что они показывают слишком малое освещение для проверки с любого расстояния, поэтому они будут приводить к ошибкам в расположениях в месте, а иногда также за поверхностью.
   * В частности, поверхностные поверхности могут проверяться только при просмотре на голове, а не при просмотре с неглубокого угла.
   * Зеркала, поскольку они создают иллусори отражения реальных пробелов и поверхностей, могут привести к ошибкам в дырах и ошибкам халлуЦинатион.

* **Движение сцены**
   * Пространственное сопоставление быстро адаптируется к изменениям в среде, например при перемещении людей или открытии и закрытии дверей.
   * Однако пространственное сопоставление может адаптироваться только к изменениям в области, когда эта область четко видна камере, используемой для сканирования.
   * По этой причине эта адаптация может отставать от реальности, что приводит к ошибкам отверстий или халлуЦинатион.
   * Например, пользователь просматривает друга, а затем переходит в тот период, когда он покидает комнату. Представление "Фантом" дружественной функции (халлуЦинатион Error) будет сохраняться в данных пространственного сопоставления, пока пользователь не вернет и не выполнит повторное сканирование места, где был занят друг.

* **Помехи освещения**
   * Внешнее инфракрасное излучение в сцене может помешать сканированию, например, в течение какого-то периода в окне.
   * В частности, поверхностные поверхности могут мешать сканированию ближайших поверхностей, что негативно приводит к возникновению ошибок смещения.
   * Блестящие поверхности, отражающие освещение непосредственно в камере, могут мешать ближайшему пространству, вызывая плавающий халлуЦинатионс середины воздуха или откладывая адаптацию к сцене движения.
   * Два устройства HoloLens в одной комнате не должны мешать друг другу, но наличие более чем пяти устройств HoloLens может вызвать помехи.

Некоторые из этих ошибок можно избежать или исправить. Однако следует спроектировать приложение таким образом, чтобы пользователь мог достичь своих целей даже при наличии ошибок в данных пространственного сопоставления.

## <a name="the-environment-scanning-experience"></a>Процесс сканирования среды

HoloLens узнает о поверхностях в своей среде по мере того, как пользователь просматривает их. Со временем HoloLens создает сканирование всех частей обнаруженной среды. Он также обновляет проверку по мере обнаружения изменений в среде. Эта проверка будет автоматически сохраняться между запусками приложений.

Каждое приложение, использующее пространственное сопоставление, должно использовать проверку. процесс, с помощью которого приложение помогает пользователю проверять поверхности, необходимые для правильной работы приложения.

![Пример сканирования](images/sr-mixedworld-140429-8pm-00068-1000px.png)<br>
*Пример сканирования*

Характер этого процесса сканирования может сильно различаться в зависимости от потребностей конкретного приложения, но при проектировании необходимо иметь два основных принципа.

Во-первых, необходимо **четко понять, что связь с пользователем является основной задачей**. Пользователь всегда должен знать, выполняются ли требования приложения. Если они не выполняются, необходимо сразу же очистить пользователя, почему это так, и они должны быстро принять соответствующие меры.

Во-вторых, **приложения должны попытаться обеспечить баланс между эффективностью и надежностью**. Если это **возможно, приложения**должны автоматически анализировать пространственные данные сопоставления, чтобы сэкономить время пользователя. Если это невозможно, приложения должны позволить пользователю быстро предоставить приложению дополнительные сведения, необходимые для этого.

Чтобы помочь вам в проектировании правильного процесса сканирования, определите, какие из следующих возможностей применимы к вашему приложению:

* **Нет опыта сканирования**
   * Приложение может работать идеально без пошагового сканирования. Он узнает о поверхностях, которые наблюдаются в процессе естественного перемещения пользователей.
   * Например, приложение, которое позволяет пользователю рисовать на поверхностях с помощью holographic спрайпаинт, требует знания только тех поверхностей, которые в настоящее время видны пользователю.
   * Окружение может быть полностью проверено, если оно уже заняло много времени с помощью HoloLens.
   * Имейте в виду, что камера, используемая пространственным сопоставлением, может видеть только 3.1 m перед пользователем, поэтому при пространственном сопоставлении не будет сведений о более удаленных поверхностях, если пользователь не найдет их с более близкого расстояния в прошлом.
   * Так что пользователь понимает, какие поверхности были проверены, приложение должно предоставить визуальный отзыв об этом эффекте, например приведение виртуальных теней на отсканированные поверхности, может помочь пользователю разместить голограммы на этих поверхностях.
   * В этом случае ограничивающие тома наблюдателя-поверхности должны обновляться в каждом кадре в [пространственной системе координат](coordinate-systems.md), так что они следуют за пользователем.

* **Найти подходящее расположение**
   * Приложение может быть предназначено для использования в расположении с конкретными требованиями.
   * Например, приложению может потребоваться пустая область вокруг пользователя, чтобы они могли безопасно практиковаться в кунг-э.
   * Приложения должны заранее взаимодействовать с любыми конкретными требованиями и подключаться к ним с четкими визуальными отзывами.
   * В этом примере приложение должно визуализировать экстент необходимой пустой области и визуально выделить присутствие любых нежелательных объектов в этой зоне.
   * В этом случае ограничивающие тома наблюдателя Surface должны использовать заблокированную в мире [систему пространственных координат](coordinate-systems.md) в выбранном расположении.

* **Поиск подходящей конфигурации поверхностей**
   * Для приложения может потребоваться определенная конфигурация поверхностей, например две крупные, плоские и противоположные стены, чтобы создать более holographic-зал зеркал.
   * В таких случаях приложению потребуется проанализировать поверхности, предоставляемые пространственным сопоставлением для определения подходящих поверхностей, и направить пользователя к ним.
   * Если анализ области приложения не полностью надежен, у пользователя должен быть параметр Fallback. Например, если приложение неправильно определяет двери как плоскую стену, пользователю требуется простой способ исправить эту ошибку.

* **Сканирование части окружения**
   * Приложение может захватывать только часть среды, которая направляется пользователем.
   * Например, приложение сканирует часть комнаты, чтобы пользователь мог разместить holographic-классифицированную рекламу для мебели, которую планируется продать.
   * В этом случае приложение должно записывать данные пространственного сопоставления в регионах, наблюдаемых пользователем во время проверки.

* **Сканирование всей комнаты**
   * Приложению может потребоваться просмотр всех поверхностей в текущем помещении, включая пользователей, которые находятся за ним.
   * Например, игра может поставить пользователя в роль Гулливер в осаде от сотен маленьких Лиллипутианс подхода из всех направлений.
   * В таких случаях приложению необходимо определить, сколько поверхностей в текущей комнате уже было проверено, и направить пользователю взгляд на значительные промежутки.
   * Ключом к этому процессу является предоставление визуальной обратной связи, которая позволяет ясно понять, какие поверхности еще не были проверены. Приложение может, например, использовать [туман на основе расстояния](https://msdn.microsoft.com/library/windows/desktop/bb173401%28v=vs.85%29.aspx) для визуального выделения областей, не охваченных областями пространственного сопоставления.

* **Создание исходного моментального снимка окружения**
   * Приложению может потребоваться игнорировать все изменения в среде после получения исходного снимка.
   * Это может быть полезно во избежание нарушений данных, созданных пользователем, которые тесно связаны с первоначальным состоянием среды.
   * В этом случае приложение должно создать копию данных пространственного сопоставления в исходном состоянии после завершения проверки.
   * Приложения должны продолжать получать обновления данных пространственного сопоставления, если они все еще должны быть правильно перекрыто средой.
   * Продолжение обновления данных пространственного сопоставления также позволяет визуализировать все произошедшие изменения, что позволяет пользователю отличия между более ранними и текущими состояниями среды.

* **Создание моментальных снимков среды, инициированных пользователем**
   * Приложение может реагировать на изменения окружающей среды только по указанному пользователем.
   * Например, пользователь может создать несколько трехмерных "статуес" друга, записывая их в разные моменты.

* **Разрешить пользователю изменять окружение**
   * Приложение может отвечать в режиме реального времени на любые изменения, внесенные в среду пользователя.
   * Например, пользователь, рисующий прикрытием, может активировать "сцену Change" для более holographic-воспроизводимого воспроизведения на другой стороне.

* **Помочь пользователю избежать ошибок в данных пространственного сопоставления**
   * Приложению может потребоваться предоставить пользователю рекомендации, пока они проводят проверку своей среды.
   * Это может помочь пользователю избежать определенных видов [ошибок в данных пространственного сопоставления](spatial-mapping-design.md#what-influences-spatial-mapping-quality), например, не отключаясь от сунлит окон или зеркал.

Один из дополнительных сведений о том, что "Range" данных пространственного сопоставления не ограничен. При пространственном сопоставлении создается постоянная база данных с большими пространствами, она только делает эти данные доступными для приложений в "пузырьковом" ограниченном размере вокруг пользователя. Таким же, если начать с начала длинного корридора и пройти гораздо достаточно, чем с самого начала, то в конечном итоге пространственные поверхности будут исчезнуть. Разумеется, вы можете уменьшить это путем кэширования этих поверхностей в приложении, когда они исчезают из доступных данных пространственного сопоставления.

## <a name="mesh-processing"></a>Обработка сетки

Он может помочь обнаружить распространенные типы ошибок в поверхностях и фильтровать, удалять или изменять данные пространственного сопоставления соответствующим образом.

Имейте в виду, что данные пространственного сопоставления должны быть как можно точными для реальных поверхностей, поэтому любая обработка, которую вы применяете, переместит свои поверхности дальше от «правды».

Ниже приведены некоторые примеры различных типов обработки сетки, которые могут оказаться полезными.

* **Заполнение отверстия**
   * Если не удается проверить небольшой объект, состоящие из темного материала, он оставит отверстие в окружающей области.
   * Отверстия влияют на перекрытия: голограммы могут рассматриваться как отверстия в непрозрачной области реального мира.
   * Отверстия влияют на райкастс. Если вы используете райкастс, чтобы помочь пользователям взаимодействовать с Surfaces, может быть нежелательно, чтобы эти лучи проходили через отверстия. Одним из способов устранения этой проблемы является использование пакета из нескольких райкастс, охватывающих регион соответствующего размера. Это позволит отфильтровать результаты выбросов, чтобы, даже если один райкаст пройдет небольшое отверстие, статистический результат по-прежнему будет действительным. Однако следует иметь в виду, что этот подход имеет вычислительные затраты.
   * Отверстия повлияли на физические конфликты: объект, контролируемый функцией имитации физических объектов, может отбрасывать отверстие в этаже и потерять его.
   * Можно алгоритмически заполнять такие отверстия в сетке Surface. Однако необходимо настроить алгоритм таким образом, чтобы «реальные отверстия», например Windows и заталкивает, не заполняются. Надежное отличие "реальных дыр" от "мнимых отверстий" может быть затруднено, поэтому необходимо поэкспериментировать с различными эвристиками, такими как "size" и "Граничный фигура".

* **Удаление халлуЦинатион**
   * Отражения, яркие индикаторы и движущие объекты могут оставлять небольшие задержки "халлуЦинатионс" плавающей точкой в середине воздуха.
   * ХаллуЦинатионс влияет на перекрытия: халлуЦинатионс может стать видимым, как темные фигуры перемещаются впереди и окклудинг другие голограммы.
   * ХаллуЦинатионс влияет на райкастс. Если вы используете райкастс, чтобы помочь пользователям взаимодействовать с поверхностями, эти лучи могут попасть на халлуЦинатион, а не на поверхность. Как и в случае с отверстиями, одним из способов устранения этой проблемы является использование многих райкастс вместо одного райкаст, но опять же это повлечет за собой вычислительные затраты.
   * ХаллуЦинатионс влияет на конфликты физических объектов: объект, контролируемый имитацией физикы, может быть задержан на халлуЦинатион и не может перемещаться по пустой области пространства.
   * Можно отфильтровать такие халлуЦинатионс из сетки Surface. Однако, как и в случае с отверстиями, необходимо настроить алгоритм таким образом, чтобы реальные небольшие объекты, такие как лампы и маркеры двери, не удалялись.

* **Сглаживания**
   * Пространственное сопоставление может возвращать поверхности, которые выглядят как грубые или "шумные" в сравнении с реальными аналогами.
   * Гладкость влияет на конфликты физической связи: Если этаж является приблизительным, физически смоделированный шарик гольфа может не двигаться плавно по линии в прямой строке.
   * Плавность влияет на отрисовку. Если поверхность отображается напрямую, грубые нормали поверхности могут повлиять на внешний вид и нарушают вид "очистить". Это можно устранить с помощью соответствующего освещения и текстур в шейдере, который используется для визуализации поверхности.
   * Можно сгладить неровности в сетке поверхности. Тем не менее, это может помещать поверхность с соответствующей реальной поверхности. Поддержание близкой корреспонденции важна для создания точной перекрытияной голограммы и предоставления пользователям возможности достичь точных и предсказуемых взаимодействий с Holographic.
   * Если требуется только косметические изменения, может быть достаточно для сглаживания нормалей вершин без изменения положений вершин.

* **Поиск плоскости**
   * Существует множество видов анализа, которые приложение может выполнять на поверхностях, предоставляемых пространственным сопоставлением.
   * Одним из простых примеров является "Поиск в плоскости"; определение ограниченных, преимущественно плоских областей поверхностей.
   * Плоские регионы можно использовать как holographic рабочих поверхностей, регионы, где holographic-содержимое может автоматически размещаться приложением.
   * Плоские регионы могут ограничивать пользовательский интерфейс, чтобы помочь пользователям взаимодействовать с поверхностями, которые лучше подходят для их нужд.
   * Плоские регионы можно использовать как в реальной среде, для holographic аналогов с функциональными объектами, такими как ЖК-экраны, таблицы или доски.
   * Плоские регионы могут определять области воспроизведения, образуя видеогаме уровней.
   * Плоские регионы могут помочь виртуальным агентам перемещаться по реальному миру, определяя области основания, с которыми могут посвящены реальные люди.

## <a name="prototyping-and-debugging"></a>Создание прототипов и отладка

### <a name="useful-tools"></a>Полезные средства
* [Эмулятор hololens](using-the-hololens-emulator.md) можно использовать для разработки приложений, использующих пространственное сопоставление без доступа к физическим HoloLens. Он позволяет имитировать динамический сеанс на HoloLens в реалистичной среде, при этом все данные, которые обычно будут использоваться приложением, включают в себя движение HoloLens, пространственные системы координат и сетки пространственных сопоставлений. Это можно использовать для предоставления надежных, повторяемых входных данных, которые могут оказаться полезными при отладке проблем и оценке изменений в коде.
* Чтобы воспроизвести сценарии, запишите данные пространственного сопоставления по сети из динамического HoloLens, а затем сохраните их на диск и повторно используйте в последующих сеансах отладки.
* [Трехмерное представление портала устройств Windows](using-the-windows-device-portal.md#3d-view) позволяет просматривать все пространственные поверхности, доступные в настоящее время через систему пространственных сопоставлений. Это дает основание для сравнения пространственных поверхностей внутри приложения; Например, можно легко определить, отсутствуют ли пространственные поверхности или они отображаются в неправильном месте.

### <a name="general-prototyping-guidance"></a>Общие рекомендации по созданию прототипов
* Поскольку [ошибки](spatial-mapping-design.md#what-influences-spatial-mapping-quality) в данных пространственного сопоставления могут сильно повлиять на взаимодействие с пользователем, рекомендуется тестировать приложение в самых разных средах.
* Не загляните в привычку всегда тестировать в одном месте, например на рабочем столе. Обязательно протестируйте различные поверхности различных позиций, фигур, размеров и материалов.
* Аналогичным образом, хотя синтетические или записанные данные могут быть полезны для отладки, они не будут прилагаться к одному и тому же небольшому количеству тестовых случаев. Это может задержать Поиск важных проблем, которые более разнообразные тесты будут перехвачены ранее.
* Рекомендуется выполнять тестирование с реальными пользователями (и в идеале), поскольку они не могут использовать HoloLens или приложение точно так же, как это делается. На самом деле, это может неожиданно повлиять на поведение людей, знание и допущения.

## <a name="see-also"></a>См. также
* [Визуализация при сканировании комнаты](room-scan-visualization.md)
* [Проектирование пространственного звука](spatial-sound-design.md)
* [Сохраняемость в Unity](persistence-in-unity.md)
